name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
  DOTNET_NOLOGO: true
  CARGO_TERM_COLOR: always
  NUGET_PACKAGES: ${{ github.workspace }}/.nuget/packages

jobs:
  native:
    name: Build native (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            artifact: native-linux
          - os: macos-latest
            artifact: native-macos
          - os: windows-latest
            artifact: native-windows
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - uses: dtolnay/rust-toolchain@stable

      - name: Build native library
        run: cargo build --release
        working-directory: vello_cpu_ffi

      - name: Upload native artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: vello_cpu_ffi/target/release/*vello_cpu_ffi.*
          if-no-files-found: error

  managed:
    name: Build managed packages
    runs-on: ubuntu-latest
    needs: native
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - uses: actions/setup-dotnet@v4
        with:
          global-json-file: global.json

      - name: Download native artifacts (linux)
        uses: actions/download-artifact@v4
        with:
          name: native-linux
          path: artifacts/native-linux

      - name: Download native artifacts (macos)
        uses: actions/download-artifact@v4
        with:
          name: native-macos
          path: artifacts/native-macos

      - name: Download native artifacts (windows)
        uses: actions/download-artifact@v4
        with:
          name: native-windows
          path: artifacts/native-windows

      - name: Stage native binaries for packaging
        run: |
          mkdir -p vello_cpu_ffi/target/release
          for dir in artifacts/native-linux artifacts/native-macos artifacts/native-windows; do
            if [ -d "$dir" ]; then
              find "$dir" -type f -name '*vello_cpu_ffi.*' -exec cp -v {} vello_cpu_ffi/target/release/ \;
            fi
          done

      - name: Restore .NET solution
        run: dotnet restore dotnet/Vello.sln

      - name: Build .NET solution
        run: dotnet build dotnet/Vello.sln -c Release --no-restore

      - name: Pack Vello.Native
        run: dotnet pack dotnet/src/Vello.Native/Vello.Native.csproj -c Release -o dotnet/NuGet --no-restore --no-build

      - name: Pack Vello
        run: dotnet pack dotnet/src/Vello/Vello.csproj -c Release -o dotnet/NuGet --no-restore --no-build

      - name: Pack Vello.Avalonia
        run: dotnet pack dotnet/src/Vello.Avalonia/Vello.Avalonia.csproj -c Release -o dotnet/NuGet --no-restore --no-build

      - name: Upload NuGet packages
        uses: actions/upload-artifact@v4
        with:
          name: nuget-packages
          path: dotnet/NuGet/*.nupkg
          if-no-files-found: error

  integration:
    name: Integration tests (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    needs: managed
    strategy:
      matrix:
        os: [ ubuntu-latest, macos-latest, windows-latest ]
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - uses: actions/setup-dotnet@v4
        with:
          global-json-file: global.json

      - name: Download NuGet packages
        uses: actions/download-artifact@v4
        with:
          name: nuget-packages
          path: artifacts/nuget

      - name: Prepare local NuGet feed
        run: |
          rm -rf dotnet/NuGet
          mkdir -p dotnet/NuGet
          find artifacts/nuget -type f -name '*.nupkg' -exec cp {} dotnet/NuGet/ \;
        shell: bash

      - name: Restore integration project
        run: dotnet restore dotnet/tests/Vello.IntegrationTest/Vello.IntegrationTest.csproj

      - name: Run integration test
        run: dotnet run --project dotnet/tests/Vello.IntegrationTest/Vello.IntegrationTest.csproj -c Release
